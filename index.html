<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ”¥ IGNATIUS DATA HUBS â€¢ Working Payment Gateway</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        /* ... KEEP ALL YOUR EXISTING STYLES ... */
        /* (Your existing CSS is perfect, just add this at the end) */
        
        /* Add API Status Indicator */
        .api-status-bar {
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(90deg, #00cc00, #00ff00);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.3);
            display: none;
            animation: slideInRight 0.5s ease-out;
        }
        
        .api-status-bar.error {
            background: linear-gradient(90deg, #ff3333, #ff6666);
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3);
        }
        
        .api-status-bar.warning {
            background: linear-gradient(90deg, #ff9900, #ffcc00);
            box-shadow: 0 5px 15px rgba(255, 153, 0, 0.3);
        }
    </style>
</head>
<body>
    <!-- Add API Status Bar -->
    <div id="apiStatusBar" class="api-status-bar"></div>
    
    <!-- ... KEEP ALL YOUR EXISTING HTML ... -->
    <!-- (Your existing HTML structure is perfect) -->
    
    <!-- ========== FIXED JAVASCRIPT ========== -->
    <script type="text/javascript">
        // ========== FIXED API BASE URL ==========
        // This is the CORRECT way to get the API base URL for Vercel
        const API_BASE_URL = window.location.origin + '/api/mpesa';
        console.log('API Base URL:', API_BASE_URL);
        
        // Test if we're on localhost
        const IS_LOCALHOST = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        console.log('Is Localhost:', IS_LOCALHOST);
        
        // ... KEEP ALL YOUR EXISTING JAVASCRIPT VARIABLES AND FUNCTIONS ...
        
        // ========== FIXED API TEST FUNCTION ==========
        async function testApiConnection() {
            const statusBar = document.getElementById('apiStatusBar');
            
            try {
                console.log('Testing API connection to:', API_BASE_URL);
                
                const response = await fetch(API_BASE_URL);
                const data = await response.json();
                
                if (data.status === 'active') {
                    statusBar.textContent = `âœ… API Connected (${data.environment})`;
                    statusBar.className = 'api-status-bar';
                    
                    // Show additional info
                    setTimeout(() => {
                        showNotification(`API Connected! Till: ${data.till_number}`, 'success');
                    }, 1000);
                    
                    return true;
                } else {
                    throw new Error('API not active');
                }
            } catch (error) {
                console.error('API Connection Error:', error);
                
                statusBar.textContent = 'âš ï¸ API Connection Failed - Using Simulation';
                statusBar.className = 'api-status-bar warning';
                
                // Show for 5 seconds
                setTimeout(() => {
                    statusBar.style.display = 'none';
                }, 5000);
                
                return false;
            }
        }
        
        // ========== FIXED PAYMENT INITIATION ==========
        async function initiatePayment() {
            const phoneInput = document.getElementById('phoneInput').value.trim();
            
            if (!phoneInput || phoneInput.length < 10) {
                showError('Please enter a valid phone number (e.g., 0712345678)');
                return;
            }
            
            // Format phone
            let formattedPhone = phoneInput;
            if (formattedPhone.startsWith('0')) {
                formattedPhone = '254' + formattedPhone.substring(1);
            }
            
            // Validate
            if (!/^2547\d{8}$/.test(formattedPhone)) {
                showError('Please enter a valid Safaricom number starting with 07');
                return;
            }
            
            // Test API first
            const apiConnected = await testApiConnection();
            
            if (!apiConnected) {
                // Fallback to simulation mode
                simulatePayment(formattedPhone);
                return;
            }
            
            // REAL API CALL
            const button = document.getElementById('initiatePayment');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SENDING...';
            
            document.getElementById('phoneInputSection').style.display = 'none';
            document.getElementById('paymentStatus').style.display = 'block';
            
            try {
                console.log('Sending payment request to API:', {
                    phoneNumber: formattedPhone,
                    amount: currentDeal.amount
                });
                
                const response = await fetch(`${API_BASE_URL}/stkpush`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phoneNumber: formattedPhone,
                        amount: currentDeal.amount,
                        accountReference: 'Ignatius Data Hubs',
                        transactionDesc: currentDeal.details.substring(0, 13)
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'API request failed');
                }
                
                if (data.success) {
                    // Show success
                    document.getElementById('checkoutInfo').innerHTML = `
                        <div style="text-align: center; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                            <div style="color: #00ff00; font-size: 1.2rem; margin-bottom: 10px;">
                                <i class="fas fa-check-circle"></i> STK Push Sent!
                            </div>
                            <div style="color: #aaddff; font-size: 0.9rem;">
                                ${data.data.customerMessage}<br>
                                Till: <strong>${data.data.tillNumber}</strong> â€¢ Amount: <strong>${currentDeal.price}</strong>
                            </div>
                        </div>
                    `;
                    
                    currentTransaction = data.data;
                    startStatusPolling(data.data.checkoutRequestId);
                    showNotification('STK Push sent! Check your phone', 'success');
                    
                } else {
                    throw new Error(data.message || 'Payment failed');
                }
                
            } catch (error) {
                console.error('Payment Error:', error);
                
                // Fallback to simulation
                simulatePayment(formattedPhone);
                
                // Reset button
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-paper-plane"></i> SEND TO TILL 7894520';
            }
        }
        
        // ========== SIMULATION MODE (FALLBACK) ==========
        function simulatePayment(phone) {
            console.log('Using simulation mode for phone:', phone);
            
            document.getElementById('phoneInputSection').style.display = 'none';
            document.getElementById('paymentStatus').style.display = 'block';
            
            // Simulate API delay
            setTimeout(() => {
                const transactionId = `SIM${Date.now().toString().slice(-8)}`;
                const checkoutId = `SIM${Math.random().toString(36).substr(2, 9).toUpperCase()}`;
                
                currentTransaction = {
                    id: transactionId,
                    checkoutRequestId: checkoutId,
                    phoneNumber: phone,
                    amount: currentDeal.amount,
                    tillNumber: '7894520',
                    customerMessage: 'STK Push simulation complete. Check your phone.'
                };
                
                document.getElementById('checkoutInfo').innerHTML = `
                    <div style="text-align: center; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                        <div style="color: #ff9900; font-size: 1.2rem; margin-bottom: 10px;">
                            <i class="fas fa-flask"></i> SIMULATION MODE
                        </div>
                        <div style="color: #ffdd88; font-size: 0.9rem;">
                            Using simulation mode<br>
                            Till: <strong>7894520</strong> â€¢ Amount: <strong>${currentDeal.price}</strong>
                        </div>
                    </div>
                `;
                
                // Auto-simulate success after 5 seconds
                setTimeout(() => {
                    simulateSuccess();
                }, 5000);
                
            }, 2000);
        }
        
        function simulateSuccess() {
            document.getElementById('paymentStatus').style.display = 'none';
            document.getElementById('successScreen').style.display = 'block';
            
            const date = new Date().toLocaleString('en-KE', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            document.getElementById('transactionDetails').innerHTML = `
                <div class="transaction-row">
                    <span class="transaction-label">Transaction ID:</span>
                    <span class="transaction-value">SIM${Date.now().toString().slice(-8)}</span>
                </div>
                <div class="transaction-row">
                    <span class="transaction-label">Product:</span>
                    <span class="transaction-value">${currentDeal.details}</span>
                </div>
                <div class="transaction-row">
                    <span class="transaction-label">Amount:</span>
                    <span class="transaction-value">${currentDeal.price}</span>
                </div>
                <div class="transaction-row">
                    <span class="transaction-label">Till Number:</span>
                    <span class="transaction-value">7894520</span>
                </div>
                <div class="transaction-row">
                    <span class="transaction-label">Status:</span>
                    <span class="transaction-value" style="color: #00ff00;">Completed âœ“</span>
                </div>
                <div class="transaction-row">
                    <span class="transaction-label">Mode:</span>
                    <span class="transaction-value" style="color: #ff9900;">Simulation</span>
                </div>
                <div class="transaction-row">
                    <span class="transaction-label">Time:</span>
                    <span class="transaction-value">${date}</span>
                </div>
            `;
            
            showNotification('Simulated payment successful!', 'success');
            simulateDataActivation();
        }
        
        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            // ... your existing initialization code ...
            
            // Test API connection on load
            setTimeout(() => {
                testApiConnection();
            }, 1000);
            
            // Auto-fill test phone
            setTimeout(() => {
                document.getElementById('phoneInput').value = "0712345678";
            }, 500);
        });
        
        // ========== DEBUG HELPER ==========
        // Add this to test API endpoints manually
        window.debugAPI = async function() {
            console.log('=== DEBUG API ===');
            console.log('Base URL:', API_BASE_URL);
            
            try {
                // Test health endpoint
                const health = await fetch(API_BASE_URL);
                console.log('Health:', await health.json());
                
                // Test config endpoint
                const config = await fetch(API_BASE_URL + '/config');
                console.log('Config:', await config.json());
                
                alert('API Debug complete. Check console.');
            } catch (error) {
                console.error('Debug Error:', error);
                alert('API Debug failed: ' + error.message);
            }
        };
        
        // Press F12 to debug
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12') {
                e.preventDefault();
                window.debugAPI();
            }
        });
    </script>
</body>
  </html>
